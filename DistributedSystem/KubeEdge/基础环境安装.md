#### 1. 基础环境

操作系统：Ubuntu 22.04

工具：

* `netstat` sudo apt install net-tools
* `curl`
* `ntp`时间同步

配置：系统配置网络IP

#### 2. 云原生基础

Centos8 docker image：  镜像，docker pull centos:centos8    验证，`cat /etc/os-release`。

`docker save -o hello-world.tar hello-world:latest`

> 表格中 - 号代表部分功能不支持、或者完全不支持

| Kubernetes version       | KubeEdge version | KubeVirt version | Rancher(RKE2) | Kubesphere(kk) |
| ------------------------ | ---------------- | ---------------- | ------------- | -------------- |
| 1.27、（**1.28**）、1.29 | 1.18             |                  | 2.8.x         | -              |
| （**1.26**）、1.27、1.28 | 1.17             |                  | 2.7.6         | 3.4.1-         |
| 1.25、（**1.26**）、1.27 | 1.16             |                  | 2.7.6         | 3.4.1-         |
| 1.23.x                   |                  |                  |               | 3.4.1          |

结论推荐Rancher、KK安装，支撑新版本-KubeEdge有更丰富的特性。

##### 2.1.离线安装

> 关闭SElinux

调研Rancher、KK安装，两者却别和差距，选择合理的部署方式。

> kubeadmin 安装注意事项:
>
> * 网络、端口打开和开放
> * Linux 禁用swap分区
> * HostName、MAC 唯一在不同节点

（1）KK安装系统

> KK 安装Kubesphere https://kubesphere.io/zh/docs/v3.4/installing-on-linux/introduction/air-gapped-installation/
>

（2）Rancher安装系统

**Rancher安装RKE2**

> Rancher安装K8s RKE2附带了containd，不需要安装docker
>
> RKE2 文档 https://docs.rke2.io/zh/install/airgap    
>
> 资料地址 https://github.com/rancher/rke2/releases/tag/v1.28.13-rc1%2Brke2r1

**K8s集群中安装Rancher**

> 下载文件，按照高可用方式安装。
>
> https://blog.csdn.net/XiaoWang0777/article/details/139806264
>
> https://ranchermanager.docs.rancher.com/zh/how-to-guides/new-user-guides/infrastructure-setup/ha-rke2-kubernetes-cluster



 https://zhuanlan.zhihu.com/p/710908622



**离线安装Rancher， K8s 集群安装https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/other-installation-methods/air-gapped-helm-cli-install、Docker安装**

**https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/install-upgrade-on-a-kubernetes-cluster**

https://ranchermanager.docs.rancher.com/zh/reference-guides/best-practices/rancher-server/rancher-deployment-strategy



**RKE2 配置信息https://ranchermanager.docs.rancher.com/zh/getting-started/installation-and-upgrade/other-installation-methods/air-gapped-helm-cli-install/install-kubernetes#1-%E5%88%9B%E5%BB%BA-rke2-%E9%85%8D%E7%BD%AE**



##### 2.2 安装Harbor

**On a Linux host:** docker 20.10.10-ce+ and docker-compose 1.18.0+ 、OpenSSL

```shell
# 1. 安装docker，拷贝所有deb文件到服务器文件夹
sudo dpkg -i *.deb
  
# 2.测试启动docker  
systemctl enable docker
sudo service docker start

docker load -i hello-world.tar
sudo docker run hello-world (可选)
 
# 3.安装docker-compose插件/usr/local/bin/docker-compose
mv docker-compose /usr/local/bin/docker-compose
chmod +777 /usr/local/bin/docker-compose

# 4.配置工具软连接（可选）
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

# 5.解压Harbor offline
tar xzvf harbor-offline-installer-v2.11.1.tgz

# 6.修改Harbor 配置文件
cp harbor.yml.tmpl harbor.yml
hostname: IP
http.port: 5000
harbor_admin_password: 12345


# 7.执行安装
./install.sh --with-trivy


# 8.浏览器测试http://IP:5000/能否登录， admin/12345
# 9.配置docker仓库，并推送测试
vim /etc/docker/daemon.json
{
"insecure-registries" : ["IP:5000", "0.0.0.0"]
}

sudo systemctl daemon-reload
systemctl restart docker

docker login -u admin -p 12345 http://IP:5000


# 其他
systemctl restart docker
docker-compose down -v
docker-compose up -d
```





##### 2.3 安装过程

```shell
sudo -i #1.切换到root用户
mkdir -p /var/lib/rancher/rke2/agent/images/ #2.创建目录
chmod +777 /var/lib/rancher/rke2/agent/images/ #3.修改权限
# 4.拷贝安装包到目录
# 5.修改安装包执行权限
# 6.移动解压rke2.linux-amd64 到/usr/local/bin/rke2
tar xzf /var/lib/rancher/rke2/agent/images/rke2.linux-amd64.tar.gz -C /usr/local
# 7.移动service文件到systemd
mv -f /usr/local/lib/systemd/system/rke2-*.service /etc/systemd/system/
# 8.检测service服务启动 systemctl status rke2-server.service
systemctl daemon-reload
# 9.服务启动
systemctl enable rke2-server.service
systemctl start rke2-server.service
# 10.查看安装日志
journalctl -u rke2-server -f
# 11.镜像安装进程查看
journalctl -xeu rke2-server.service | grep tar.gz


# 其他配置
mkdir -p /etc/rancher/rke2/
chmod +777 /etc/rancher/rke2/
/etc/rancher/rke2/config.yaml
```

##### 2.4 卸载环境

```shell
# 切换root用户
./usr/local/bin/rke2-killall.sh
./usr/local/bin/rke2-uninstall.sh
```

##### 2.5 RKE2安装配置

把 config.yaml 文件创建到 `/etc/rancher/rke2/config.yaml` 中。这将包含创建高可用 RKE2 集群所需的所有配置选项。

第一台服务器的最低配置是：

```yaml
token: my-shared-secret
tls-san:
  - loadbalancer-dns-domain.com
```

其他服务器的配置文件应该包含相同的令牌，并让 RKE2 知道要连接到现有的第一台服务器：

```yaml
server: https://ip-of-first-server:9345
token: my-shared-secret
tls-san:
  - loadbalancer-dns-domain.com
```



##### 2.6 RKE2镜像地址配置(optional)

把 `registries.yaml` 文件创建到 `/etc/rancher/rke2/registries.yaml` 中。此文件为 RKE2 提供连接到你的私有镜像仓库的详细信息。

在加入必要信息之前，`registries.yaml` 文件是这样的：

```yaml
---
mirrors:
  customreg:
    endpoint:
      - "https://ip-to-server:5000"
configs:
  customreg:
    auth:
      username: xxxxxx # 镜像仓库的用户名
      password: xxxxxx # 镜像仓库的密码
    tls:
      cert_file: <镜像仓库所用的证书文件路径>
      key_file:  <镜像仓库所用的密钥文件路径>
      ca_file: <镜像仓库所用的 CA 文件路径>
```







#### 3. K8s的可视化界面:

* 容器监控工具WeaveScope
* OKD Web控制台
* Dashbards
* Platform9

